<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Management - Student Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .navbar .nav-links {
            display: flex;
            gap: 15px;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .course-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .course-header h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .course-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .meta-item {
            color: #666;
            font-size: 0.95rem;
        }

        .meta-item strong {
            color: #333;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-core {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-elective {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-lab {
            background: #e8f5e9;
            color: #388e3c;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stat-card .number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
        }

        .students-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-header h3 {
            color: #333;
            font-size: 1.5rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .grade-input {
            width: 80px;
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .grade-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .marks-input {
            width: 100px;
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .marks-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-select {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-enrolled {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-completed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .grade-badge {
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .grade-a, .grade-a-plus {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .grade-b, .grade-b-plus {
            background: #bbdefb;
            color: #1565c0;
        }

        .grade-c, .grade-c-plus {
            background: #fff9c4;
            color: #f57f17;
        }

        .grade-d {
            background: #ffccbc;
            color: #d84315;
        }

        .grade-f {
            background: #ffebee;
            color: #c62828;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .bulk-actions {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .bulk-actions label {
            font-weight: 600;
            color: #333;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1 onclick="window.location.href='/teacher-dashboard'">üë®‚Äçüè´ Grade Management</h1>
        <div class="nav-links">
            <a href="/teacher-dashboard">‚Üê Back to Dashboard</a>
            <a href="/" onclick="sessionStorage.clear()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div id="loadingCourse" class="loading">Loading course details...</div>

        <div id="courseContent" style="display: none;">
            <div class="course-header">
                <h2 id="courseName">Course Name</h2>
                <div class="course-meta">
                    <span class="meta-item"><strong>Code:</strong> <span id="courseCode">-</span></span>
                    <span class="meta-item"><strong>Credits:</strong> <span id="courseCredits">-</span></span>
                    <span class="meta-item"><strong>Semester:</strong> <span id="courseSemester">-</span></span>
                    <span class="meta-item"><strong>Department:</strong> <span id="courseDepartment">-</span></span>
                    <span class="meta-item"><strong>Type:</strong> <span id="courseType" class="badge">-</span></span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üë•</div>
                    <h3>Total Students</h3>
                    <div class="number" id="totalStudents">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚úÖ</div>
                    <h3>Graded</h3>
                    <div class="number" id="gradedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚è≥</div>
                    <h3>Pending</h3>
                    <div class="number" id="pendingCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üìä</div>
                    <h3>Average</h3>
                    <div class="number" id="averageGrade">-</div>
                </div>
            </div>

            <div class="students-section">
                <div class="section-header">
                    <h3>üìù Enrolled Students & Grades</h3>
                    <button class="btn btn-success" onclick="saveAllGrades()">üíæ Save All Grades</button>
                </div>

                <div id="successAlert" class="success-message" style="display: none;">
                    Grades saved successfully!
                </div>

                <div id="errorAlert" class="error-message" style="display: none;">
                    Failed to save grades. Please try again.
                </div>

                <div id="studentsLoading" class="loading">Loading enrolled students...</div>

                <div id="studentsTable" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Roll Number</th>
                                <th>Student Name</th>
                                <th>Email</th>
                                <th>Marks (0-100)</th>
                                <th>Grade</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsBody">
                        </tbody>
                    </table>
                </div>

                <div id="noStudents" class="empty-state" style="display: none;">
                    <h3>üì≠ No Students Enrolled</h3>
                    <p>No students have enrolled in this course yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let currentCourse = null;
        let enrollments = [];
        const courseId = new URLSearchParams(window.location.search).get('courseId');

        window.addEventListener('DOMContentLoaded', async function() {
            // Require teacher authentication
            if (!requireRole('TEACHER')) {
                return;
            }

            if (!courseId) {
                alert('No course ID provided');
                window.location.href = '/teacher-dashboard';
                return;
            }

            await loadCourseAndStudents();
        });

        async function loadCourseAndStudents() {
            try {
                // Load course details with authentication
                const courseResponse = await fetchWithAuth('/api/courses/all');
                const courses = await courseResponse.json();
                currentCourse = courses.find(c => c.id == courseId);

                if (!currentCourse) {
                    alert('Course not found');
                    window.location.href = '/teacher-dashboard';
                    return;
                }

                displayCourseDetails(currentCourse);

                // Load enrollments for this course
                const enrollmentResponse = await fetch(`/api/enrollments/course/${courseId}`);
                enrollments = await enrollmentResponse.json();

                displayEnrollments(enrollments);
                updateStats(enrollments);

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load course data: ' + error.message);
            }
        }

        function displayCourseDetails(course) {
            document.getElementById('loadingCourse').style.display = 'none';
            document.getElementById('courseContent').style.display = 'block';

            document.getElementById('courseName').textContent = course.name;
            document.getElementById('courseCode').textContent = course.courseCode;
            document.getElementById('courseCredits').textContent = course.credits || 'N/A';
            document.getElementById('courseSemester').textContent = course.semester;
            document.getElementById('courseDepartment').textContent = course.department ? course.department.name : 'N/A';

            const typeElement = document.getElementById('courseType');
            typeElement.textContent = course.courseType;
            typeElement.className = `badge badge-${course.courseType.toLowerCase()}`;
        }

        function displayEnrollments(enrollments) {
            document.getElementById('studentsLoading').style.display = 'none';

            if (enrollments.length === 0) {
                document.getElementById('noStudents').style.display = 'block';
                return;
            }

            document.getElementById('studentsTable').style.display = 'block';

            const tbody = document.getElementById('studentsBody');
            tbody.innerHTML = '';

            enrollments.forEach((enrollment, index) => {
                const student = enrollment.student || {};
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${student.rollNumber || 'N/A'}</strong></td>
                    <td>${student.name || 'N/A'}</td>
                    <td>${student.email || 'N/A'}</td>
                    <td>
                        <input type="number"
                               class="marks-input"
                               id="marks-${enrollment.id}"
                               value="${enrollment.marks !== null && enrollment.marks !== undefined ? enrollment.marks : ''}"
                               min="0"
                               max="100"
                               onchange="calculateGrade(${enrollment.id})"
                               placeholder="0-100">
                    </td>
                    <td>
                        <select class="status-select" id="grade-${enrollment.id}">
                            <option value="">-</option>
                            <option value="A+" ${enrollment.grade === 'A+' ? 'selected' : ''}>A+</option>
                            <option value="A" ${enrollment.grade === 'A' ? 'selected' : ''}>A</option>
                            <option value="B+" ${enrollment.grade === 'B+' ? 'selected' : ''}>B+</option>
                            <option value="B" ${enrollment.grade === 'B' ? 'selected' : ''}>B</option>
                            <option value="C+" ${enrollment.grade === 'C+' ? 'selected' : ''}>C+</option>
                            <option value="C" ${enrollment.grade === 'C' ? 'selected' : ''}>C</option>
                            <option value="D" ${enrollment.grade === 'D' ? 'selected' : ''}>D</option>
                            <option value="F" ${enrollment.grade === 'F' ? 'selected' : ''}>F</option>
                        </select>
                    </td>
                    <td>
                        <select class="status-select" id="status-${enrollment.id}">
                            <option value="ENROLLED" ${enrollment.status === 'ENROLLED' ? 'selected' : ''}>Enrolled</option>
                            <option value="COMPLETED" ${enrollment.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                            <option value="DROPPED" ${enrollment.status === 'DROPPED' ? 'selected' : ''}>Dropped</option>
                            <option value="FAILED" ${enrollment.status === 'FAILED' ? 'selected' : ''}>Failed</option>
                        </select>
                    </td>
                    <td>
                        <input type="text"
                               class="grade-input"
                               id="remarks-${enrollment.id}"
                               value="${enrollment.remarks || ''}"
                               placeholder="Optional remarks"
                               style="width: 150px;">
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="saveGrade(${enrollment.id})">Save</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateGrade(enrollmentId) {
            const marks = parseFloat(document.getElementById(`marks-${enrollmentId}`).value);
            const gradeSelect = document.getElementById(`grade-${enrollmentId}`);

            if (isNaN(marks) || marks < 0 || marks > 100) {
                return;
            }

            let grade = '';
            if (marks >= 90) grade = 'A+';
            else if (marks >= 85) grade = 'A';
            else if (marks >= 80) grade = 'B+';
            else if (marks >= 75) grade = 'B';
            else if (marks >= 70) grade = 'C+';
            else if (marks >= 65) grade = 'C';
            else if (marks >= 60) grade = 'D';
            else grade = 'F';

            gradeSelect.value = grade;

            // Auto-set status
            const statusSelect = document.getElementById(`status-${enrollmentId}`);
            if (marks >= 60) {
                statusSelect.value = 'COMPLETED';
            } else {
                statusSelect.value = 'FAILED';
            }
        }

        async function saveGrade(enrollmentId) {
            try {
                const marks = parseFloat(document.getElementById(`marks-${enrollmentId}`).value);
                const grade = document.getElementById(`grade-${enrollmentId}`).value;
                const status = document.getElementById(`status-${enrollmentId}`).value;
                const remarks = document.getElementById(`remarks-${enrollmentId}`).value;

                const gradeData = {
                    marks: isNaN(marks) ? null : marks,
                    grade: grade || null,
                    status: status || 'ENROLLED',
                    remarks: remarks || null
                };

                console.log('Saving grade for enrollment', enrollmentId, gradeData);

                const response = await fetch(`/api/enrollments/${enrollmentId}/grade`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gradeData)
                });

                if (response.ok) {
                    showSuccess('Grade saved successfully!');
                    await loadCourseAndStudents(); // Refresh data
                } else {
                    const error = await response.json();
                    showError('Failed to save grade: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving grade:', error);
                showError('Error saving grade: ' + error.message);
            }
        }

        async function saveAllGrades() {
            if (!confirm('Save grades for all students?')) {
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const enrollment of enrollments) {
                try {
                    await saveGrade(enrollment.id);
                    successCount++;
                } catch (error) {
                    console.error('Error saving grade for enrollment', enrollment.id, error);
                    failCount++;
                }
                // Small delay to avoid overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            if (failCount === 0) {
                showSuccess(`All ${successCount} grades saved successfully!`);
            } else {
                showError(`Saved ${successCount} grades. ${failCount} failed.`);
            }

            await loadCourseAndStudents(); // Refresh data
        }

        function updateStats(enrollments) {
            const total = enrollments.length;
            const graded = enrollments.filter(e => e.grade && e.grade !== '').length;
            const pending = total - graded;

            let totalMarks = 0;
            let marksCount = 0;

            enrollments.forEach(e => {
                if (e.marks !== null && e.marks !== undefined && !isNaN(e.marks)) {
                    totalMarks += e.marks;
                    marksCount++;
                }
            });

            const average = marksCount > 0 ? (totalMarks / marksCount).toFixed(1) : '-';

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('gradedCount').textContent = graded;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('averageGrade').textContent = average;
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            document.getElementById('errorAlert').style.display = 'none';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            document.getElementById('successAlert').style.display = 'none';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
