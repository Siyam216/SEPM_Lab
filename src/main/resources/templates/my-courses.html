<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Courses - Student Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .navbar .nav-links {
            display: flex;
            gap: 20px;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h2 {
            font-size: 2rem;
            color: #333;
        }

        .add-course-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }

        .add-course-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .courses-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 18px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-ENROLLED {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-COMPLETED {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-DROPPED {
            background: #ffebee;
            color: #d32f2f;
        }

        .grade-badge {
            padding: 5px 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        .grade-A, .grade-A-plus {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .grade-B, .grade-B-plus {
            background: #bbdefb;
            color: #1565c0;
        }

        .grade-C, .grade-C-plus {
            background: #fff9c4;
            color: #f57f17;
        }

        .grade-pending {
            background: #f5f5f5;
            color: #757575;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #667eea;
        }

        .no-courses {
            text-align: center;
            padding: 60px;
        }

        .no-courses h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .no-courses p {
            color: #666;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1 onclick="window.location.href='/dashboard'">ðŸŽ“ Student Management System</h1>
        <div class="nav-links">
            <a href="/dashboard">Dashboard</a>
            <a href="/profile">My Profile</a>
            <a href="/my-courses">My Courses</a>
            <a href="/" onclick="sessionStorage.clear()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <div>
                <h2>ðŸ“š My Enrolled Courses</h2>
                <p style="color: #666; margin-top: 5px;">View your current and past enrollments</p>
            </div>
            <a href="/courses" class="add-course-btn">+ Enroll in New Course</a>
        </div>

        <div id="loading" class="loading">
            Loading your courses...
        </div>

        <div id="noCourses" class="no-courses" style="display: none;">
            <h3>ðŸ“­ You haven't enrolled in any courses yet</h3>
            <p>Start your academic journey by enrolling in courses that match your interests!</p>
            <a href="/courses" class="add-course-btn">Browse Available Courses</a>
        </div>

        <div id="coursesTable" class="courses-table" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Credits</th>
                        <th>Teacher</th>
                        <th>Status</th>
                        <th>Grade</th>
                        <th>Marks</th>
                    </tr>
                </thead>
                <tbody id="coursesBody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', async function() {
            // Require authentication
            if (!requireAuth()) {
                return;
            }
            await loadEnrollments();
        });

        async function loadEnrollments() {
            try {
                const userEmail = getUserInfo().email;

                console.log('Loading enrollments for:', userEmail);

                if (!userEmail) {
                    console.error('No email in sessionStorage');
                    logout();
                    return;
                }

                // Get current student with authentication
                console.log('Fetching students...');
                const studentsResponse = await fetchWithAuth('/api/students');

                if (!studentsResponse.ok) {
                    throw new Error('Failed to fetch students: ' + studentsResponse.status);
                }

                const students = await studentsResponse.json();
                console.log('Students fetched:', students.length);

                const currentStudent = students.find(s =>
                    s.email && s.email.toLowerCase() === userEmail.toLowerCase()
                );

                if (!currentStudent) {
                    console.error('Student not found with email:', userEmail);
                    throw new Error('Student not found with email: ' + userEmail);
                }

                console.log('Current student:', currentStudent);

                // Get all enrollments with authentication
                console.log('Fetching enrollments...');
                const enrollmentsResponse = await fetchWithAuth('/api/enrollments');

                if (!enrollmentsResponse.ok) {
                    throw new Error('Failed to fetch enrollments: ' + enrollmentsResponse.status);
                }

                const allEnrollments = await enrollmentsResponse.json();
                console.log('All enrollments fetched:', allEnrollments.length);
                console.log('All enrollments:', allEnrollments);

                // Filter current student's enrollments
                const myEnrollments = allEnrollments.filter(e => {
                    console.log('Checking enrollment:', e);
                    return e.student && e.student.id === currentStudent.id;
                });

                console.log('My enrollments:', myEnrollments);

                displayEnrollments(myEnrollments);

            } catch (error) {
                console.error('Error loading enrollments:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loading').innerHTML =
                    `<p style="color: #c33;">Failed to load courses: ${error.message}</p>
                     <p style="color: #666; margin-top: 10px;">Please check the console for details.</p>
                     <button onclick="window.location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>`;
                document.getElementById('loading').style.display = 'block';
            }
        }

        function displayEnrollments(enrollments) {
            try {
                document.getElementById('loading').style.display = 'none';

                if (enrollments.length === 0) {
                    document.getElementById('noCourses').style.display = 'block';
                    return;
                }

                document.getElementById('coursesTable').style.display = 'block';

                const tbody = document.getElementById('coursesBody');
                tbody.innerHTML = '';

                enrollments.forEach((enrollment, index) => {
                    console.log('Processing enrollment', index, enrollment);

                    // Safely access course data with null checks
                    const course = enrollment.course || {};
                    const teacher = course.teacher || null;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${course.courseCode || 'N/A'}</strong></td>
                        <td>${course.name || 'Unknown Course'}</td>
                        <td>${course.credits || 'N/A'}</td>
                        <td>${teacher ? teacher.name : 'TBA'}</td>
                        <td><span class="status-badge status-${enrollment.status || 'ENROLLED'}">${enrollment.status || 'ENROLLED'}</span></td>
                        <td><span class="grade-badge ${enrollment.grade ? 'grade-' + enrollment.grade.replace('+', '-plus') : 'grade-pending'}">${enrollment.grade || 'Pending'}</span></td>
                        <td>${enrollment.marks !== null && enrollment.marks !== undefined ? enrollment.marks : 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });

                console.log('Successfully displayed', enrollments.length, 'enrollments');
            } catch (error) {
                console.error('Error displaying enrollments:', error);
                document.getElementById('loading').innerHTML =
                    `<p style="color: #c33;">Error displaying courses: ${error.message}</p>
                     <button onclick="window.location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>`;
                document.getElementById('loading').style.display = 'block';
            }
        }
    </script>
</body>
</html>
